<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tienyulin.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"CKNGBQCM6Q","apiKey":"aa8f782cff7f67f246a3fd15f8592fc1","indexName":"tienyulin.github.com","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="在 Redis 系列文章的第一篇 Redis (一) - 基本概念 我們有介紹過 Redis 是一個 in-memory 的資料庫，所以資料都會被儲存在記憶體中，這樣的好處是可以提升資料的存取速度。 以往想要將資料放在記憶體來提升存取速度大多是使用 Session 來達成，但是 Session 會因為電腦或伺服器被關閉而被清除。更麻煩的問題是當一個應用要部署到多台伺服器上來分散流量的話 Sessi">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis (六) - 主從複製、哨兵與叢集模式">
<meta property="og:url" content="https://tienyulin.github.io/redis-6_master-slave-replication-sentinel-cluster/">
<meta property="og:site_name" content="Tienyu Note">
<meta property="og:description" content="在 Redis 系列文章的第一篇 Redis (一) - 基本概念 我們有介紹過 Redis 是一個 in-memory 的資料庫，所以資料都會被儲存在記憶體中，這樣的好處是可以提升資料的存取速度。 以往想要將資料放在記憶體來提升存取速度大多是使用 Session 來達成，但是 Session 會因為電腦或伺服器被關閉而被清除。更麻煩的問題是當一個應用要部署到多台伺服器上來分散流量的話 Sessi">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.imgur.com/GLSvDQu.png">
<meta property="og:image" content="https://i.imgur.com/6KHCYvi.png">
<meta property="og:image" content="https://i.imgur.com/j8f7PAn.png">
<meta property="og:image" content="https://i.imgur.com/8iKPBct.png">
<meta property="og:image" content="https://i.imgur.com/AmqNRKJ.png">
<meta property="article:published_time" content="2020-07-26T00:00:00.000Z">
<meta property="article:modified_time" content="2020-07-26T00:00:00.000Z">
<meta property="article:author" content="Tien-Yu Lin">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="NoSQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/GLSvDQu.png">

<link rel="canonical" href="https://tienyulin.github.io/redis-6_master-slave-replication-sentinel-cluster/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Redis (六) - 主從複製、哨兵與叢集模式 | Tienyu Note</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-169323232-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-169323232-1');
      }
    </script>







<script data-ad-client="ca-pub-8271558544185929" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tienyu Note</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Fly with me</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">45</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-folder-open fa-fw"></i>Categories<span class="badge">28</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">29</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/tienyulin" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://tienyulin.github.io/redis-6_master-slave-replication-sentinel-cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tienyu.jpg">
      <meta itemprop="name" content="Tien-Yu Lin">
      <meta itemprop="description" content="Try not to become a man of success, but rather try to become a man of value. - Albert Einstein">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tienyu Note">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis (六) - 主從複製、哨兵與叢集模式
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-26 00:00:00" itemprop="dateCreated datePublished" datetime="2020-07-26T00:00:00+00:00">2020-07-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoSQL/" itemprop="url" rel="index"><span itemprop="name">NoSQL</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoSQL/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/redis-6_master-slave-replication-sentinel-cluster/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="redis-6_master-slave-replication-sentinel-cluster/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>在 Redis 系列文章的第一篇 <a href="https://tienyulin.github.io/redis-concept-docker-install-datatype/">Redis (一) - 基本概念</a> 我們有介紹過 Redis 是一個 in-memory 的資料庫，所以資料都會被儲存在記憶體中，這樣的好處是可以提升資料的存取速度。</p>
<p>以往想要將資料放在記憶體來提升存取速度大多是使用 <a href="https://tienyulin.github.io/session-cookie/">Session</a> 來達成，但是 Session 會因為電腦或伺服器被關閉而被清除。更麻煩的問題是當一個應用要部署到多台伺服器上來分散流量的話 Session 就會不同步，這樣會導致資料和結果不正確。</p>
<a id="more"></a>
<p>所以另外一種作法就是搭配 <a href="https://tienyulin.github.io/session-cookie/">Cookie</a> 存放 Session Id 然後把 Session 資料存到資料庫來解決資料不同步的問題，但是這樣就要每次都去資料庫讀資料反而會增加存取的時間。</p>
<p>因此 Redis 提供了一些非常實用的功能來實現多機的 in-memory 資料庫，如下:</p>
<ul>
<li>主從複製模式 (Master-Slave Replication)</li>
<li>哨兵模式 (Sentinel)</li>
<li>叢集模式 (Cluster)</li>
</ul>
<h2 id="主從複製模式"><a class="header-anchor" href="#主從複製模式"></a>主從複製模式</h2>
<p>主從複製模式提供讓 Master(主伺服器) 向任意數量的 Slave(附屬伺服器) 進行資料同步，以解決單點資料庫的問題。</p>
<p>主從複製模式最主要的目的是要實現讀寫分離和資料備份。Redis 讀寫分離的作法是 Master 可以進行讀取和寫入，其他的 Slave 只能讀取。透過 Slave 幫忙處理讀取的工作來減輕 Master 的負擔。</p>
<p><img src="https://i.imgur.com/GLSvDQu.png" alt="master-slave replication"></p>
<h3 id="工作流程"><a class="header-anchor" href="#工作流程"></a>工作流程</h3>
<ol>
<li>Slave 啟動之後會主動向 Master 發送 <code>Sync</code> 命令要求進行同步。</li>
<li>Master 收到之後會執行 <code>Bgsave</code> 命令建立 <code>rdb</code> <a href="https://www.getit01.com/p20180115420374919/" target="_blank" rel="noopener">快照</a>檔案儲存到硬碟。同時，Master 會把新收到的寫入和修改資料庫的命令存到緩衝區。</li>
<li>Master 會將剛建立好的快照檔案傳給 Slave。</li>
<li>Slave 收到快照檔案後會先把記憶體清空，接著載入收到的快照檔案。</li>
<li>Master 會再把存在緩衝區的命令傳給 Slave，Slave 再執行這些命令以達成和 Master 同步。</li>
<li>以上便完成了 Slave 的資料初始化，此後只要 Master 每執行一道寫入或修改資料庫的命令都會傳送給 Slave 以達到資料的同步。</li>
<li>Master 和 Slave 會互相發送 heartbeat 的訊息，也就是傳送 Ping 指令。以告知對方我還正常運作也檢查對方是否還正常運作。</li>
</ol>
<h3 id="範例"><a class="header-anchor" href="#範例"></a>範例</h3>
<p>這裡我們使用 <a href="https://tienyulin.github.io/docker-compose/">Docker-Compose</a> 來實作範例，因為 Docker-Compose 可以一次快速啟動多個 Container。</p>
<p><a href="https://github.com/tienyulin/docker-redis-master-slave.git" target="_blank" rel="noopener">範例 github 連結</a></p>
<p>若你不使用 Docker-Compose 可以直接在 Redis 裡下 <code>Slaveof</code> 指令來設定，指令用法請參考 <a href="https://tienyulin.github.io/redis-server-management/#Slaveof">Redis (五) - 管理 Redis Server</a>。</p>
<p>首先先建立一個名為 master-slave 的資料夾，並在資料夾內建立 docker-compose.yml，我們建立一個 Master 和 兩個 Slave，且兩個 Slave 指定要作為 Master 的 Slave。</p>
<p>此外在建立 Container 時，也用 Volume 掛載了本機的資料夾到 Container 的 data 資料夾，在 <a href="https://tienyulin.github.io/redis-server-management/#Slaveof">Redis (五) - 管理 Redis Server</a> 中有提到資料持久化的 AOF 檔和 rdb 檔會儲存在 Redis 安裝目錄下，也就是 data 資料夾。所以為了避免 Container 故障停止造成資料遺失，必須要將資料同步到主機上。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">    <span class="attr">master:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">redis-master</span></span><br><span class="line">        <span class="attr">volumes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">./data/redis-master/data:/data</span></span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">slave1:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">redis-slave1</span></span><br><span class="line">        <span class="attr">volumes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">./data/redis-slave1/data:/data</span></span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="number">6380</span><span class="string">:6379</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--slaveof</span> <span class="string">redis-master</span> <span class="number">6379</span></span><br><span class="line">        <span class="attr">depends_on:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">slave2:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">redis-slave2</span></span><br><span class="line">        <span class="attr">volumes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">./data/redis-slave2/data:/data</span></span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="number">6381</span><span class="string">:6379</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--slaveof</span> <span class="string">redis-master</span> <span class="number">6379</span></span><br><span class="line">        <span class="attr">depends_on:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">slave1</span></span><br></pre></td></tr></table></figure>
<p>設定好 docker-compose.yml 後就可以啟動 docker-compose。接下來我們來看一下每個 Redis Server 的角色。這裡為了一起顯示出三個 Redis Server 的結果，就不進到每個 Redis Server 的 Container 裡面操作，直接用 docker exec 操作。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-master redis-cli info replication | grep role</span></span><br><span class="line">role:master</span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-slave1 redis-cli info replication | grep role</span></span><br><span class="line">role:slave</span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-slave2 redis-cli info replication | grep role</span></span><br><span class="line">role:slave</span><br></pre></td></tr></table></figure>
<p>接著再向 Master 寫入一筆資料，可以看到馬上就同步到兩個 Slave 了。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-master redis-cli <span class="built_in">set</span> k1 v1</span></span><br><span class="line">OK</span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-slave1 redis-cli get k1</span></span><br><span class="line">"v1"</span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-slave2 redis-cli get k1</span></span><br><span class="line">"v1"</span><br></pre></td></tr></table></figure>
<h2 id="哨兵模式"><a class="header-anchor" href="#哨兵模式"></a>哨兵模式</h2>
<p>哨兵模式用於監控 Redis 系統，哨兵會監控 Master 是否正常運行。當 Master 出現故障或下線時，哨兵會將其所屬的其中一個 Slave 升格為 Master，並將其他的 Slave 指向新的 Master。</p>
<p><img src="https://i.imgur.com/6KHCYvi.png" alt="Sentinel"></p>
<h3 id="監控"><a class="header-anchor" href="#監控"></a>監控</h3>
<p>哨兵會和要監控的 Master 建立兩條連接，<code>Cmd</code> 和 <code>Pub/Sub</code>。</p>
<ul>
<li>Cmd 是哨兵用來定期向 Master 發送 <code>Info</code> 命令以取得 Master 的訊息，訊息中也會包含 Master 有哪些 Slave。當獲得了 Slave 的訊息時哨兵也同樣會和 Slave 建立兩條連結。</li>
<li>此外哨兵也會定期透過 Cmd 向 Master、Slave和其他哨兵發送 <code>Ping</code> 指令來作為心跳檢測，確認節點的狀態。</li>
<li><a href="https://tienyulin.github.io/redis-pubsub/">Pub/Sub</a> 讓哨兵可以透過訂閱 Master 和 Slave 的 <code>__sentinel__:hello</code> 這個頻道來和其他哨兵定期的進行資訊交換。</li>
</ul>
<h3 id="主觀下線"><a class="header-anchor" href="#主觀下線"></a>主觀下線</h3>
<p>主觀下線指的是單個哨兵認為 Master 已經停止服務了，有可能是網路不通或是接收不到訂閱等等。而哨兵判斷的依據是在傳送 Ping 指令之後一定的時間內沒有回覆或是回傳錯誤，則哨兵就會主觀的認為這個 Master 已經下線停止服務了。</p>
<h3 id="客觀下線"><a class="header-anchor" href="#客觀下線"></a>客觀下線</h3>
<p>客觀下線指的是由多個哨兵對同一個 Master 各自進行主觀下線的判斷，再綜合所有哨兵的判斷。若認為主觀下線的哨兵到達一定的數量(配置文件中的 quorum)，則即為客觀下線。</p>
<p>客觀下線會由起初認定 Master 主觀下線的哨兵發起，該哨兵會向其他的哨兵發送訊息詢問他們是否認為這個 Master 主觀下線。</p>
<h3 id="故障轉移-Failover"><a class="header-anchor" href="#故障轉移-Failover"></a>故障轉移 (Failover)</h3>
<p>當 Master 已經被標記為客觀下線時，起初發現 Master 下線的哨兵會發起一個選舉(採用 Raft 演算法)，並要求其他哨兵選他做為領頭哨兵，領頭哨兵會負責進行故障的恢復。當選的標準是要有超過一半的哨兵同意，所以哨兵的數量建議是設定奇數個。</p>
<p>此時若有多個哨兵同時參選領頭哨兵，則有可能會發生一輪之內沒有產生勝選者，則所有的哨兵會再等待一個隨機的時間再次發起參選的請求，進行下一輪的選舉，一直到選出領頭為止。所以若哨兵為偶數個就很有可能一直無法產生領頭哨兵。</p>
<p>選出領頭哨兵之後，領頭哨兵會開始從下線的 Master 所屬的 Slave 中挑選一個出來升格為新的 Master，挑選的依據如下 :</p>
<ol>
<li>所有在線的 Slave 擁有最高優先權的，優先權可以透過 slave-priority 設定。</li>
<li>如果有多個同為最高優先權的 Slave，則選取複製偏移量最大的(複製最完整的)。</li>
<li>若還是有多個 Slave 皆符合上述條件，則選取 id 最小的。</li>
</ol>
<p>接著領頭哨兵會向選出來的 Slave 發送命令將其升格為 Master，然後再向其他 Slave 發送命令指向新的 Master 並進行數據的複製。</p>
<p>最後領頭哨兵會將舊的 Master 更新為新的 Master 的 Slave，讓其恢復服務後以 Slave 的身分繼續運作。</p>
<h3 id="範例-v2"><a class="header-anchor" href="#範例-v2"></a>範例</h3>
<p>前面我們已經有建立一組 Master-Slave 的 Redis Server，現在我們就建立一組哨兵來監控這組 Redis Server。</p>
<p><a href="https://github.com/tienyulin/docker-redis-sentinel.git" target="_blank" rel="noopener">範例 github 連結</a></p>
<p><strong>檔案結構</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├─sentinel</span><br><span class="line">|    ├─docker-compose.yml</span><br><span class="line">|    ├─sentinel1.conf</span><br><span class="line">|    ├─sentinel2.conf</span><br><span class="line">|    └sentinel3.conf</span><br></pre></td></tr></table></figure>
<p>首先要先下載範例的 <a href="http://download.redis.io/redis-stable/redis.conf" target="_blank" rel="noopener">sentinel.conf</a>，接著修改以下部分。<code>redis-master-ip</code> 可以透過 <code>docker inspect redis-master | grep &quot;IPAddress&quot;</code> 取得。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 設定要監控的 Master，最後的 2 代表判定客觀下線所需的哨兵數</span></span><br><span class="line">sentinel monitor mymaster &lt;redis-master-ip&gt; 6379 2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 哨兵 Ping 不到 Master 超過此毫秒數會認定主觀下線，預設30秒，因測試改5秒</span></span><br><span class="line">sentinel down-after-milliseconds mymaster 5000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> failover 超過次毫秒數即代表 failover 失敗，預設3分鐘</span></span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure>
<p>修改完後將 sentinel.conf 複製成 3 份，並重新命名為 sentinel1.conf、sentinel2.conf、sentinel3.conf。接著將 sentinel2.conf 和 sentinel3.conf 的 port 分別改成 26380 和 26381。</p>
<p>接下來我們要建立 docker-compose.yml，並將剛剛建好的 sentinel.conf 使用 Volume 掛載進哨兵的 Redis Container，如下。如果不用 docker-compose 或是 Volume，也可以用 Dockerfile 將 sentinel.conf 直接複製進去。使用 Dockerfile 會更輕鬆，想了解請參考 <a href="https://github.com/tienyulin/Redis-docker/tree/master/sentinel-dockerfile" target="_blank" rel="noopener">我的 github</a>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">    <span class="attr">sentinel1:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">redis-sentinel1</span></span><br><span class="line">        <span class="attr">build:</span> </span><br><span class="line">            <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">REDIS_PORT=26379</span></span><br><span class="line">        <span class="attr">volumes:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">./data/redis-sentinel1/data:/data</span></span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="number">26379</span><span class="string">:26379</span>               </span><br><span class="line">    <span class="attr">sentinel2:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">redis-sentinel2</span></span><br><span class="line">        <span class="attr">build:</span></span><br><span class="line">            <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">            <span class="attr">args:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">REDIS_PORT=26380</span></span><br><span class="line">        <span class="attr">volumes:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">./data/redis-sentinel2/data:/data</span></span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="number">26380</span><span class="string">:26379</span></span><br><span class="line">    <span class="attr">sentinel3:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">redis-sentinel3</span></span><br><span class="line">        <span class="attr">build:</span> </span><br><span class="line">            <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">            <span class="attr">args:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">REDIS_PORT=26381</span></span><br><span class="line">        <span class="attr">volumes:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">./data/redis-sentinel3/data:/data</span></span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="number">26381</span><span class="string">:26379</span></span><br><span class="line"><span class="attr">networks:</span> </span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">        <span class="attr">external:</span> </span><br><span class="line">            <span class="attr">name:</span> <span class="string">master-slave_default</span></span><br></pre></td></tr></table></figure>
<p>這個 docker-compose.yml 最後還有指定網路的環境，因為 Docker Compose 預設啟動時會為啟動的 Container 建立網路環境，而這些 Container 就可以互相溝通。但是現在哨兵和 Master-Slave 並不是一起被建立起來的，所以必須要指定 Master-Slave 使用的網路環境給哨兵，這樣哨兵才能和 Master-Slave 互動。不過如果網路模式選擇 <code>host</code> 則不需要再特別設定連結到 master-slave 的網路。</p>
<p>上述步驟都完成後就可以啟動 docker-compose，並且可以看到會輸出下面這些資訊，這些資訊代表哨兵已經開始監視 Master 而且也獲得了 Slave 的資訊。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">redis-sentinel1 | 1:X 23 Jul 2020 08:56:03.301 # +monitor master mymaster 172.30.0.2 6379 quorum 2</span><br><span class="line">redis-sentinel1 | 1:X 23 Jul 2020 08:56:03.302 * +slave slave 172.30.0.3:6379 172.30.0.3 6379 @ mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel1 | 1:X 23 Jul 2020 08:56:03.483 * +slave slave 172.30.0.4:6379 172.30.0.4 6379 @ mymaster 172.30.0.2 6379</span><br><span class="line">...</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 08:56:03.301 # +monitor master mymaster 172.30.0.2 6379 quorum 2</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 08:56:03.302 * +slave slave 172.30.0.3:6379 172.30.0.3 6379 @ mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 08:56:03.456 * +slave slave 172.30.0.4:6379 172.30.0.4 6379 @ mymaster 172.30.0.2 6379</span><br><span class="line">...</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 08:56:03.261 # +monitor master mymaster 172.30.0.2 6379 quorum 2</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 08:56:03.262 * +slave slave 172.30.0.3:6379 172.30.0.3 6379 @ mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 08:56:03.456 * +slave slave 172.30.0.4:6379 172.30.0.4 6379 @ mymaster 172.30.0.2 6379</span><br></pre></td></tr></table></figure>
<p>也可以使用下面這個指令來查看哨兵的資訊。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-sentinel1 redis-cli -p 26379 info sentinel</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=172.30.0.2:6379,slaves=2,sentinels=3</span><br></pre></td></tr></table></figure>
<h4 id="故障轉移"><a class="header-anchor" href="#故障轉移"></a>故障轉移</h4>
<p>接著我們來嘗試一下故障轉移，先停止 redis-master 這個 Container，這時哨兵就會開始啟動故障轉移，以下是進行故障轉移時的輸出。</p>
<p>首先可以看到三個哨兵都認定 master 為 sdown(主觀下線)，這時 Sentinel3 便認定為 odown(客觀下線)，並打算發起投票要求成為領頭哨兵。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel1 | 1:X 23 Jul 2020 09:28:35.907 # +sdown master mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:35.907 # +sdown master mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 09:28:35.919 # +sdown master mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 09:28:35.990 # +odown master mymaster 172.30.0.2 6379 #quorum 3/2</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 09:28:35.990 # +new-epoch 1</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 09:28:35.990 # +try-failover master mymaster 172.30.0.2 6379</span><br></pre></td></tr></table></figure>
<p>與此同時 Sentinel2 也認定為客觀下線，雖然看起來是 Sentinel3 先認定客觀下線打算發起投票了，但是最後還是由 Sentinel2 發起投票要求成為領頭哨兵。Sentinel2 和 Sentinel3 都加入參選且各自投給自己，Sentinel1 則沒有投票所以這一輪流局。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:35.990 # +odown master mymaster 172.30.0.2 6379 #quorum 2/2</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:35.990 # +new-epoch 1</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:35.990 # +try-failover master mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:36.066 # +vote-for-leader 8ce97092515e4e1f53f5bdfa276676c664dc100b 1</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:36.092 # 8fc467a6fa4a1d798be4a054d78db4c5db10fb97 voted for 8fc467a6fa4a1d798be4a054d78db4c5db10fb97 1</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 09:28:36.092 # +vote-for-leader 8fc467a6fa4a1d798be4a054d78db4c5db10fb97 1</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 09:28:36.092 # 8ce97092515e4e1f53f5bdfa276676c664dc100b voted for 8ce97092515e4e1f53f5bdfa276676c664dc100b 1</span><br></pre></td></tr></table></figure>
<p>Sentinel1 再次發起了一輪投票要推舉 Sentinel2 為領頭哨兵，Sentinel2 和 Sentinel3 都投給 Sentinel2，所以最後 Sentinel2 當選。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel1 | 1:X 23 Jul 2020 09:28:36.124 # +new-epoch 1</span><br><span class="line">redis-sentinel1 | 1:X 23 Jul 2020 09:28:36.162 # +vote-for-leader 8ce97092515e4e1f53f5bdfa276676c664dc100b 1</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 09:28:36.162 # 8fc467a6fa4a1d798be4a054d78db4c5db10fb97 voted for 8ce97092515e4e1f53f5bdfa276676c664dc100b 1</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:36.162 # 8ce97092515e4e1f53f5bdfa276676c664dc100b voted for 8ce97092515e4e1f53f5bdfa276676c664dc100b 1</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:36.211 # +elected-leader master mymaster 172.30.0.2 6379</span><br></pre></td></tr></table></figure>
<p>接著 Sentinel2 選出了 redis-slave1(slave 172.30.0.3:6379) 作為 Master，並且下了 <code>slaveof no one</code> 的指令使其解除 Slave 狀態變回獨立的 Master，隨後將 redis-slave1 升格為 Master。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:36.211 # +failover-state-select-slave master mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:36.268 # +selected-slave slave 172.30.0.3:6379 172.30.0.3 6379 @ mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:36.268 * +failover-state-send-slaveof-noone slave 172.30.0.3:6379 172.30.0.3 6379 @ mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:36.339 * +failover-state-wait-promotion slave 172.30.0.3:6379 172.30.0.3 6379 @ mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:36.584 # +promoted-slave slave 172.30.0.3:6379 172.30.0.3 6379 @ mymaster 172.30.0.2 6379</span><br></pre></td></tr></table></figure>
<p>設定完新的 Master 後，Sentinel2 讓原本的 Master 轉為 Slave，並且讓 redis-slave2(172.30.0.4:6379) 指向新的 Master。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:36.584 # +failover-state-reconf-slaves master mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:36.610 * +slave-reconf-sent slave 172.30.0.4:6379 172.30.0.4 6379 @ mymaster 172.30.0.2 6379</span><br></pre></td></tr></table></figure>
<p>Sentinel1 和 Sentinel3 開始從 Sentinel2 取得設定然後更新自己的設定，至此整個故障轉移就完成了。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel1 | 1:X 23 Jul 2020 09:28:36.611 # +config-update-from sentinel 8ce97092515e4e1f53f5bdfa276676c664dc100b 172.30.0.7 26380 @ mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 09:28:36.611 # +config-update-from sentinel 8ce97092515e4e1f53f5bdfa276676c664dc100b 172.30.0.7 26380 @ mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 09:28:36.611 # +switch-master mymaster 172.30.0.2 6379 172.30.0.3 6379</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 09:28:36.611 * +slave slave 172.30.0.4:6379 172.30.0.4 6379 @ mymaster 172.30.0.3 6379</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 09:28:36.611 * +slave slave 172.30.0.2:6379 172.30.0.2 6379 @ mymaster 172.30.0.3 6379</span><br><span class="line">redis-sentinel1 | 1:X 23 Jul 2020 09:28:36.611 # +switch-master mymaster 172.30.0.2 6379 172.30.0.3 6379</span><br><span class="line">redis-sentinel1 | 1:X 23 Jul 2020 09:28:36.611 * +slave slave 172.30.0.4:6379 172.30.0.4 6379 @ mymaster 172.30.0.3 6379</span><br><span class="line">redis-sentinel1 | 1:X 23 Jul 2020 09:28:36.611 * +slave slave 172.30.0.2:6379 172.30.0.2 6379 @ mymaster 172.30.0.3 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:37.284 # -odown master mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:37.284 * +slave-reconf-inprog slave 172.30.0.4:6379 172.30.0.4 6379 @ mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:37.284 * +slave-reconf-done slave 172.30.0.4:6379 172.30.0.4 6379 @ mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:37.355 # +failover-end master mymaster 172.30.0.2 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:37.355 # +switch-master mymaster 172.30.0.2 6379 172.30.0.3 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:37.355 * +slave slave 172.30.0.4:6379 172.30.0.4 6379 @ mymaster 172.30.0.3 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:37.355 * +slave slave 172.30.0.2:6379 172.30.0.2 6379 @ mymaster 172.30.0.3 6379</span><br></pre></td></tr></table></figure>
<p>此時因為 redis-master 還是處於關閉的狀態，所以三個哨兵還是會判斷其為主觀下線，但是因為他已經成為 Slave，所以不會進行故障轉移。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel1 | 1:X 23 Jul 2020 09:28:41.616 # +sdown slave 172.30.0.2:6379 172.30.0.2 6379 @ mymaster 172.30.0.3 6379</span><br><span class="line">redis-sentinel3 | 1:X 23 Jul 2020 09:28:41.631 # +sdown slave 172.30.0.2:6379 172.30.0.2 6379 @ mymaster 172.30.0.3 6379</span><br><span class="line">redis-sentinel2 | 1:X 23 Jul 2020 09:28:42.402 # +sdown slave 172.30.0.2:6379 172.30.0.2 6379 @ mymaster 172.30.0.3 6379</span><br></pre></td></tr></table></figure>
<p>這時再次啟動 redis-master，Sentinel2 會正式的將 redis-master 轉換為 Slave。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel2 | 1:X 24 Jul 2020 01:02:17.484 * +convert-to-slave slave 172.30.0.2:6379 172.30.0.2 6379 @ mymaster 172.30.0.3 6379</span><br></pre></td></tr></table></figure>
<h2 id="叢集模式"><a class="header-anchor" href="#叢集模式"></a>叢集模式</h2>
<p>叢集模式是用來提供 Redis 分散式的需求，以解決單台伺服器的記憶體容量有限的問題。前面介紹的主從複製模式仍然只有一台主伺服器在進行寫入，其他的附屬伺服器只是將數據備份過來幫忙分散讀取的工作而已。</p>
<p>然而叢集模式無法像主從複製模式實現讀寫分離，Slave 只負責備份資料不提供服務。</p>
<p><img src="https://i.imgur.com/j8f7PAn.png" alt="Cluster"></p>
<h3 id="資料分片"><a class="header-anchor" href="#資料分片"></a>資料分片</h3>
<p>叢集模式採用了 <a href="https://zhuanlan.zhihu.com/p/57185574" target="_blank" rel="noopener">Sharding(分片)</a> 的技術，自動地將資料拆分到多台的伺服器上，以水平的擴充記憶體的容量。</p>
<p>Redis 引入了 <code>Hash Slot(槽)</code> 來實現資料的拆分，Hash Slot 是用於紀錄資料和節點之間的關聯，Redis 會將多個 Key 映射到一個 Hash Slot。</p>
<p>一個 Redis 叢集包含了 16384 個 Hash Slot，叢集內所有的節點會各負責一部份的 Hash Slot。每個節點會將自己負責哪些 Slot 傳送給其他節點，這些資訊稱為 <code>Slots</code>。確切的說，Slots 是一個長度為 16384 的 Binary Array，每個節點會在自己的 Slots 上標記負責的 Slot 為 1，其他則為 0。</p>
<p><img src="https://i.imgur.com/8iKPBct.png" alt="Slots"></p>
<p>呈上，每個節點因為會收到其他節點的 Slots，所以除了自己的 Slots 外還會有一個大家都長一樣的 Slots 來記錄這 16384 個 Slot 分別指派給哪個節點。</p>
<h3 id="節點的資料結構與-Slots"><a class="header-anchor" href="#節點的資料結構與-Slots"></a>節點的資料結構與 Slots</h3>
<p>到這裡你可能會對於兩個 Slots 有點分不太清楚，我們用下面這張圖來做說明。首先最右邊一排是每個節點最基本的資料結構稱為 ClusterNode，裡面會儲存這個節點的狀態和資訊。ClusterNode 裡會儲存 Slots，這個 Slots 就是紀錄自己負責哪些 Slot。</p>
<p>此外，每個節點也都還會有一個資料結構用來記錄叢集目前的狀態，稱為 ClusterState，就是下圖的最左邊。ClusterState 是以當前節點的視角來看整個叢集的狀態，例如叢集的節點數、上下線等等。</p>
<p>ClusterState 也會儲存 Slots，這個 Slots 就是上面提到的大家都一樣的用來記錄每個 Slot 分別是指派給哪個節點。下圖中間即為 ClusterState 的 Slots，可以看到它記錄的便是每個 Slot 指向哪個 ClusterNode。另外，ClusterState 裡有還一個屬性稱為 myself，myself 會直接指向當前節點的 ClusterNode。</p>
<p><img src="https://i.imgur.com/AmqNRKJ.png" alt="ClusterState Slots"></p>
<h3 id="工作流程-v2"><a class="header-anchor" href="#工作流程-v2"></a>工作流程</h3>
<ol>
<li>當節點收到命令的時候，會先透過 CRC16 演算法取得這個 Key 是屬於哪個 Slot。</li>
<li>知道是哪個 Slot 後，節點會透過 ClusterState 的 Slots 取得這個 Slot 是由誰負責，接著再和 myself 比對是否相同。</li>
<li>如果相同代表是由當前的節點負責，那當前的節點就會執行命令。</li>
<li>如果不同代表不是由當前的節點負責，則節點會根據取得的 ClusterNode 所記錄的 IP 和 Port，回傳 MOVED 錯誤，並指引客戶端轉向到負責這個 Slot 的節點。</li>
</ol>
<h3 id="故障轉移-v2"><a class="header-anchor" href="#故障轉移-v2"></a>故障轉移</h3>
<p>叢集模式的故障轉移不需要自己建立哨兵，節點之間會自行運作並執行類似哨兵的故障處理方式。</p>
<h3 id="節點增加與刪除"><a class="header-anchor" href="#節點增加與刪除"></a>節點增加與刪除</h3>
<p>節點的刪除與增加並不會影響資料也不會造成叢集下線。增加節點時，其他的節點會分配一些 Slot 到新的節點，讓新的節點幫忙負責一部份。而刪除也是同理，當有節點被刪除時，他所負責的 Slot 會被分配到其他剩餘的節點上幫忙負責。如果是想改變一個節點上的 Slot 數量也是同樣的方法進行重新分配。</p>
<h3 id="範例-v3"><a class="header-anchor" href="#範例-v3"></a>範例</h3>
<p><a href="https://github.com/tienyulin/docker-redis-cluster.git" target="_blank" rel="noopener">範例 github 連結</a></p>
<p><strong>檔案結構</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├─cluster</span><br><span class="line">|    ├─docker-compose.yml</span><br><span class="line">|    ├─redis</span><br><span class="line">|    |   ├─Dockerfile</span><br><span class="line">|    |   └redis.conf</span><br></pre></td></tr></table></figure>
<p>首先先建立 Dockerfile，叢集模式因為節點較多 (至少要有 3 個主節點)，所以不能再像哨兵模式的範例一一掛載 conf 檔，太麻煩也太浪費時間了。就用 Dockerfile 將 conf 直接複製進 Redis Container 中。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> redis:latest</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> REDIS_PORT</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> redis.conf /etc/redis/redis.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 將 Port 改成傳進來的 Port 值</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed -i <span class="string">'s/REDIS_PORT/'</span><span class="variable">$REDIS_PORT</span><span class="string">'/g'</span> /etc/redis/redis.conf</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> redis-server /etc/redis/redis.conf</span></span><br></pre></td></tr></table></figure>
<p>接著要建立 redis.conf (<a href="http://download.redis.io/redis-stable/redis.conf" target="_blank" rel="noopener">redis 下載</a>)，redis 預設是沒有開啟叢集模式的，所以必須要在 redis.conf 開啟或加入。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 註解 <span class="built_in">bind</span> 127.0.0.1，會影響 redis 節點連接</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">bind</span> 127.0.0.1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Port 會在建立 Dockerfile 時以參數傳入並更改 redis.conf </span></span><br><span class="line">port REDIS_PORT</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 啟用叢集模式</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 叢集的設定檔</span></span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 請求超時預設 15000 毫秒</span></span><br><span class="line">cluster-node-timeout 15000</span><br></pre></td></tr></table></figure>
<p>最後要建立啟動 Redis Container 的 docker-compose.yml，可以看到每個節點在編譯 Dockerfile 時都有傳入 REDIS_PORT 這個參數來代表佔用的 Port 號。而網路模式是使用 <code>host</code>，<code>host</code> 模式才能讓外部連接進來操作。</p>
<p>這個 yaml 檔最重要的是最後一個用來建立 Cluster 的 Container，這個 Container 啟動時會使用 redis-cli --cluster create 的指令來建立 Cluster，其後所接的是主機的 IP + 節點的 Port。</p>
<p>此外指令後面還有接 --cluster-replicas 1，這是代表每個 node 會有幾個 Slave，前面有提到 Cluster 至少要有 3 個主節點，所以 yaml 檔裡才會設定了 6 個節點 (3 Master, 3 Slave)。</p>
<p>指令最後的 --cluster-yes 是為了要自動輸入 yes 以完成建立 Cluster。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">    <span class="attr">node1:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">redis-node1</span></span><br><span class="line">        <span class="attr">build:</span> </span><br><span class="line">            <span class="attr">context:</span> <span class="string">redis</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">REDIS_PORT=9001</span></span><br><span class="line">        <span class="attr">volumes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">./data/node1/data:/data</span></span><br><span class="line">        <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">node2:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">redis-node2</span></span><br><span class="line">        <span class="attr">build:</span> </span><br><span class="line">            <span class="attr">context:</span> <span class="string">redis</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">REDIS_PORT=9002</span></span><br><span class="line">        <span class="attr">volumes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">./data/node2/data:/data</span></span><br><span class="line">        <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">node3:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">redis-node3</span></span><br><span class="line">        <span class="attr">build:</span> </span><br><span class="line">            <span class="attr">context:</span> <span class="string">redis</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">REDIS_PORT=9003</span></span><br><span class="line">        <span class="attr">volumes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">./data/node3/data:/data</span></span><br><span class="line">        <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">node4:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">redis-node4</span></span><br><span class="line">        <span class="attr">build:</span> </span><br><span class="line">            <span class="attr">context:</span> <span class="string">redis</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">REDIS_PORT=9004</span></span><br><span class="line">        <span class="attr">volumes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">./data/node4/data:/data</span></span><br><span class="line">        <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">node5:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">redis-node5</span></span><br><span class="line">        <span class="attr">build:</span> </span><br><span class="line">            <span class="attr">context:</span> <span class="string">redis</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">REDIS_PORT=9005</span></span><br><span class="line">        <span class="attr">volumes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">./data/node5/data:/data</span></span><br><span class="line">        <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">node6:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">redis-node6</span></span><br><span class="line">        <span class="attr">build:</span> </span><br><span class="line">            <span class="attr">context:</span> <span class="string">redis</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">REDIS_PORT=9006</span></span><br><span class="line">        <span class="attr">volumes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">./data/node6/data:/data</span></span><br><span class="line">        <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">cluster-creator:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">redis-cluster-creator</span></span><br><span class="line">        <span class="attr">entrypoint:</span> <span class="string">redis-cli</span> <span class="string">--cluster</span> <span class="string">create</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.4</span><span class="string">:9001</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.4</span><span class="string">:9002</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.4</span><span class="string">:9003</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.4</span><span class="string">:9004</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.4</span><span class="string">:9005</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.4</span><span class="string">:9006</span> <span class="string">--cluster-replicas</span> <span class="number">1</span> <span class="string">--cluster-yes</span></span><br><span class="line">        <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">        <span class="attr">depends_on:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">node1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node5</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node6</span></span><br></pre></td></tr></table></figure>
<p>上述步驟都完成後就可以啟動 Docker Compose 了，啟動後可以找到下面這段輸出。這段輸出就是在進行 Hash Slot 的分配，Hash Slot 切成了三段後，先將 node5、node6、node4 分別分配作為 node1、node2、node3 的 Slave，接著再將 3 段 Hash Slot 分配給 node1、node2、node3。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">redis-cluster-creator | &gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span><br><span class="line">redis-cluster-creator | Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">redis-cluster-creator | Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">redis-cluster-creator | Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">redis-cluster-creator | Adding replica 192.168.100.4:9005 to 192.168.100.4:9001</span><br><span class="line">redis-cluster-creator | Adding replica 192.168.100.4:9006 to 192.168.100.4:9002</span><br><span class="line">redis-cluster-creator | Adding replica 192.168.100.4:9004 to 192.168.100.4:9003</span><br><span class="line">redis-cluster-creator | &gt;&gt;&gt; Trying to optimize slaves allocation for anti-affinity</span><br><span class="line">redis-cluster-creator | [WARNING] Some slaves are in the same host as their master</span><br><span class="line">redis-cluster-creator | M: ab3b241fa07cada74242f69e11c84494f3a87fea 192.168.100.4:9001</span><br><span class="line">redis-cluster-creator |    slots:[0-5460] (5461 slots) master</span><br><span class="line">redis-cluster-creator | M: 38e1bf11a87384f4da113c78d7b40f78e6120da0 192.168.100.4:9002</span><br><span class="line">redis-cluster-creator |    slots:[5461-10922] (5462 slots) master</span><br><span class="line">redis-cluster-creator | M: 8dc77a4d71b04a7edc4354737ae6426132c51526 192.168.100.4:9003</span><br><span class="line">redis-cluster-creator |    slots:[10923-16383] (5461 slots) master</span><br><span class="line">redis-cluster-creator | S: e90b96dae4f591656469b29288344e6c4bb9d2eb 192.168.100.4:9004</span><br><span class="line">redis-cluster-creator |    replicates 38e1bf11a87384f4da113c78d7b40f78e6120da0</span><br><span class="line">redis-cluster-creator | S: 1246d07a9f245eaebd9fd97b9043cd9c8405464b 192.168.100.4:9005</span><br><span class="line">redis-cluster-creator |    replicates 8dc77a4d71b04a7edc4354737ae6426132c51526</span><br><span class="line">redis-cluster-creator | S: c7930763878fbf5fe9025191936bdedf35901dca 192.168.100.4:9006</span><br><span class="line">redis-cluster-creator |    replicates ab3b241fa07cada74242f69e11c84494f3a87fea</span><br><span class="line">redis-cluster-creator | &gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">redis-cluster-creator | &gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">redis-cluster-creator | &gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">redis-cluster-creator | Waiting for the cluster to join</span><br></pre></td></tr></table></figure>
<p>再往下可以看到這段輸出代表建立成功。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">redis-node6 | 6:M 25 Jul 2020 15:22:23.601 # Cluster state changed: ok</span><br><span class="line">redis-node3 | 6:M 25 Jul 2020 15:22:23.604 # Cluster state changed: ok</span><br><span class="line">redis-node5 | 6:M 25 Jul 2020 15:22:23.628 # Cluster state changed: ok</span><br><span class="line">redis-node4 | 10:M 25 Jul 2020 15:22:23.634 # Cluster state changed: ok</span><br><span class="line">redis-node2 | 6:M 25 Jul 2020 15:22:23.646 # Cluster state changed: ok</span><br><span class="line">redis-node1 | 6:M 25 Jul 2020 15:22:24.511 # Cluster state changed: ok</span><br><span class="line">...</span><br><span class="line">redis-cluster-creator | ..</span><br><span class="line">redis-cluster-creator | &gt;&gt;&gt; Performing Cluster Check (using node 192.168.100.4:9001)</span><br><span class="line">redis-cluster-creator | M: ab3b241fa07cada74242f69e11c84494f3a87fea 192.168.100.4:9001</span><br><span class="line">redis-cluster-creator |    slots:[0-5460] (5461 slots) master</span><br><span class="line">redis-cluster-creator |    1 additional replica(s)</span><br><span class="line">redis-cluster-creator | S: 1246d07a9f245eaebd9fd97b9043cd9c8405464b 192.168.100.4:9005</span><br><span class="line">redis-cluster-creator |    slots: (0 slots) slave</span><br><span class="line">redis-cluster-creator |    replicates 8dc77a4d71b04a7edc4354737ae6426132c51526</span><br><span class="line">redis-cluster-creator | S: c7930763878fbf5fe9025191936bdedf35901dca 192.168.100.4:9006</span><br><span class="line">redis-cluster-creator |    slots: (0 slots) slave</span><br><span class="line">redis-cluster-creator |    replicates ab3b241fa07cada74242f69e11c84494f3a87fea</span><br><span class="line">redis-cluster-creator | S: e90b96dae4f591656469b29288344e6c4bb9d2eb 192.168.100.4:9004</span><br><span class="line">redis-cluster-creator |    slots: (0 slots) slave</span><br><span class="line">redis-cluster-creator |    replicates 38e1bf11a87384f4da113c78d7b40f78e6120da0</span><br><span class="line">redis-cluster-creator | M: 8dc77a4d71b04a7edc4354737ae6426132c51526 192.168.100.4:9003</span><br><span class="line">redis-cluster-creator |    slots:[10923-16383] (5461 slots) master</span><br><span class="line">redis-cluster-creator |    1 additional replica(s)</span><br><span class="line">redis-cluster-creator | M: 38e1bf11a87384f4da113c78d7b40f78e6120da0 192.168.100.4:9002</span><br><span class="line">redis-cluster-creator |    slots:[5461-10922] (5462 slots) master</span><br><span class="line">redis-cluster-creator |    1 additional replica(s)</span><br><span class="line">redis-cluster-creator | [OK] All nodes agree about slots configuration.</span><br><span class="line">redis-cluster-creator | &gt;&gt;&gt; Check for open slots...</span><br><span class="line">redis-cluster-creator | &gt;&gt;&gt; Check slots coverage...</span><br><span class="line">redis-cluster-creator | [OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>
<p>最後，Master 會把資料同步到 Slave，至此便完成了 Cluster 的整個建立過程。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">redis-node6 | 6:S 25 Jul 2020 15:22:25.611 * MASTER &lt;-&gt; REPLICA sync started</span><br><span class="line">...</span><br><span class="line">redis-node5 | 6:S 25 Jul 2020 15:22:25.637 * MASTER &lt;-&gt; REPLICA sync started</span><br><span class="line">...</span><br><span class="line">redis-node4 | 10:S 25 Jul 2020 15:22:25.642 * MASTER &lt;-&gt; REPLICA sync started</span><br></pre></td></tr></table></figure>
<p><strong>讀寫資料</strong><br>
Cluster 建立好後就可以試著將資料寫進 Redis Server，下面這個指令可以看到 redis-node3 判斷要寫入的 Slot 不歸自己管，便回傳了 MOVED 錯誤提醒使用者要寫在 redis-node2。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-node3 redis-cli -p 9003 <span class="built_in">set</span> k4 v4</span></span><br><span class="line">(error) MOVED 8455 192.168.100.4:9002</span><br></pre></td></tr></table></figure>
<p>然而如果每次都要使用者手動切換到其他的節點那就無法自動化的完成工作了，所以可以在 redis-cli 後面加上 <code>-c</code> 來啟動 Cluster 支援，這樣 Cluster 就會自動的導向到正確的節點並完成操作。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-node3 redis-cli -p 9003 -c <span class="built_in">set</span> k4 v4</span></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-node3 redis-cli -p 9003 -c</span></span><br><span class="line">127.0.0.1:9003&gt; set k4 v4</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [8455] located at 192.168.100.4:9002</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<p><strong>故障轉移</strong><br>
接著我們來測試一下 Cluster 的故障轉移，首先先把 redis-node1 停止，這時會有節點發現 redis-node1 發生故障。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis-node1 exited with code 137</span><br><span class="line">redis-node4        | 6:S 26 Jul 2020 00:21:28.770 * Connecting to MASTER 192.168.100.4:9001</span><br><span class="line">redis-node4        | 6:S 26 Jul 2020 00:21:28.770 * MASTER &lt;-&gt; REPLICA sync started</span><br><span class="line">redis-node4        | 6:S 26 Jul 2020 00:21:28.770 # Error condition on socket for SYNC: Operation now in progress</span><br></pre></td></tr></table></figure>
<p>當有一定數量的節點認為 redis-node1 故障時，會像哨兵模式一樣自動開始啟動選舉並且重新分配誰該成為新的 Master。此範例最後是由 redis-node4 勝出成為新的 Master，如輸出的最後一行顯示。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">redis-node4        | 6:S 26 Jul 2020 00:21:48.716 * Marking node c0d1d6b5b817c479942d199a3da2b89b89958d0e as failing (quorum reached).</span><br><span class="line">redis-node4        | 6:S 26 Jul 2020 00:21:48.716 # Start of election delayed for 912 milliseconds (rank #0, offset 84).</span><br><span class="line">redis-node4        | 6:S 26 Jul 2020 00:21:48.716 # Cluster state changed: fail</span><br><span class="line">redis-node6        | 7:S 26 Jul 2020 00:21:48.716 * FAIL message received from 9e7a868b38f55314e8bb61a1f2f527a07d1a7626 about c0d1d6b5b817c479942d199a3da2b89b89958d0e</span><br><span class="line">redis-node6        | 7:S 26 Jul 2020 00:21:48.716 # Cluster state changed: fail</span><br><span class="line">redis-node5        | 6:S 26 Jul 2020 00:21:48.716 * FAIL message received from 9e7a868b38f55314e8bb61a1f2f527a07d1a7626 about c0d1d6b5b817c479942d199a3da2b89b89958d0e</span><br><span class="line">redis-node5        | 6:S 26 Jul 2020 00:21:48.716 # Cluster state changed: fail</span><br><span class="line">redis-node3        | 6:M 26 Jul 2020 00:21:48.716 * FAIL message received from 9e7a868b38f55314e8bb61a1f2f527a07d1a7626 about c0d1d6b5b817c479942d199a3da2b89b89958d0e</span><br><span class="line">redis-node3        | 6:M 26 Jul 2020 00:21:48.716 # Cluster state changed: fail</span><br><span class="line">redis-node2        | 12:M 26 Jul 2020 00:21:48.716 * FAIL message received from 9e7a868b38f55314e8bb61a1f2f527a07d1a7626 about c0d1d6b5b817c479942d199a3da2b89b89958d0e</span><br><span class="line">redis-node2        | 12:M 26 Jul 2020 00:21:48.716 # Cluster state changed: fail</span><br><span class="line">redis-node4        | 6:S 26 Jul 2020 00:21:48.816 * Connecting to MASTER 192.168.100.4:9001</span><br><span class="line">redis-node4        | 6:S 26 Jul 2020 00:21:48.817 * MASTER &lt;-&gt; REPLICA sync started</span><br><span class="line">redis-node4        | 6:S 26 Jul 2020 00:21:48.817 # Error condition on socket for SYNC: Operation now in progress</span><br><span class="line">redis-node4        | 6:S 26 Jul 2020 00:21:49.718 # Starting a failover election for epoch 7.</span><br><span class="line">redis-node2        | 12:M 26 Jul 2020 00:21:49.719 # Failover auth granted to 9e7a868b38f55314e8bb61a1f2f527a07d1a7626 for epoch 7</span><br><span class="line">redis-node3        | 6:M 26 Jul 2020 00:21:49.719 # Failover auth granted to 9e7a868b38f55314e8bb61a1f2f527a07d1a7626 for epoch 7</span><br><span class="line">redis-node4        | 6:S 26 Jul 2020 00:21:49.720 # Failover election won: I'm the new master.</span><br></pre></td></tr></table></figure>
<p><strong>新增節點</strong><br>
新增節點前要先用原本的 Dockerfile 來建立 Image。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t redis-node-image --build-arg REDIS_PORT=9007 .</span><br></pre></td></tr></table></figure>
<p>建立好 Image 後就可以啟動新的節點。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name redis-node7 --net=host redis-node-image</span><br></pre></td></tr></table></figure>
<p>接著使用 add-node 指令將新節點加入到 Cluster 中，第一個 IP:Port 是新節點，第二個則是 Cluster 中的任意節點的。若是新節點要作為 Slave 則要再加上 <code>--cluster-slave --cluster-master-id &lt;master-node-Id&gt;</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it redis-node7 redis-cli --cluster add-node 192.168.100.4:9007 192.168.100.4:9006</span><br></pre></td></tr></table></figure>
<p>新增完成後會看到以下的輸出。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Send CLUSTER MEET to node 192.168.100.4:9007 to make it join the cluster.</span></span><br><span class="line">[OK] New node added correctly.</span><br></pre></td></tr></table></figure>
<p>此時查看一下所有節點的狀態可以看到 redis-node7 的 Connected 後面是空的，代表還沒被分配到 Hash Slot，所以我們要再進行重新的分片。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-node7 redis-cli -p 9007 cluster nodes</span></span><br><span class="line">c0d1d6b5b817c479942d199a3da2b89b89958d0e 192.168.100.4:9001@19001 slave 9e7a868b38f55314e8bb61a1f2f527a07d1a7626 0 1595731538000 7 connected</span><br><span class="line">953c929f0092a971e27d0c40b093c772ea9553bc 192.168.100.4:9002@19002 master - 0 1595731537975 2 connected 5461-10922</span><br><span class="line">d1096e4d456e806d046461c108af4f20edee9f99 192.168.100.4:9006@19006 slave 3c3a2216147a692b61b1de2a6f3806e0afa7cc87 0 1595731537000 3 connected</span><br><span class="line">af228461d8ab2c1d9998a62e684bdf23dda851c1 192.168.100.4:9007@19007 myself,master - 0 1595731536000 0 connected</span><br><span class="line">9e7a868b38f55314e8bb61a1f2f527a07d1a7626 192.168.100.4:9004@19004 master - 0 1595731536000 7 connected 0-5460</span><br><span class="line">66fa35f56d59289e0f3e2b0f531b5c590f44b189 192.168.100.4:9005@19005 slave 953c929f0092a971e27d0c40b093c772ea9553bc 0 1595731538975 2 connected</span><br><span class="line">3c3a2216147a692b61b1de2a6f3806e0afa7cc87 192.168.100.4:9003@19003 master - 0 1595731536000 3 connected 10923-16383</span><br></pre></td></tr></table></figure>
<p>重新分片可以使用 reshard 指令指定要分配多少到哪個 node，這裡我們用 rebalance 指令來平均的重新分配到各個節點上。Cluster 預設是平均分配不會分配到空的節點，所以加上 <code>--cluster-use-empty-masters</code> 就可以啟用分配到空節點上。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it redis-node7 redis-cli -p 9007 --cluster rebalance 192.168.100.4:9001 --cluster-use-empty-masters</span><br></pre></td></tr></table></figure>
<p>分配好後可以看到 redis-node7 已經有被分到一些 Slot，而其他 Master 的 Slot 也有減少。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-node7 redis-cli -p 9007 cluster nodes</span></span><br><span class="line">c0d1d6b5b817c479942d199a3da2b89b89958d0e 192.168.100.4:9001@19001 slave 9e7a868b38f55314e8bb61a1f2f527a07d1a7626 0 1595733490000 7 connected</span><br><span class="line">953c929f0092a971e27d0c40b093c772ea9553bc 192.168.100.4:9002@19002 master - 0 1595733488392 2 connected 6827-10922</span><br><span class="line">d1096e4d456e806d046461c108af4f20edee9f99 192.168.100.4:9006@19006 slave 3c3a2216147a692b61b1de2a6f3806e0afa7cc87 0 1595733490401 3 connected</span><br><span class="line">af228461d8ab2c1d9998a62e684bdf23dda851c1 192.168.100.4:9007@19007 myself,master - 0 1595733487000 8 connected 0-1364 5461-6826 10923-12287</span><br><span class="line">9e7a868b38f55314e8bb61a1f2f527a07d1a7626 192.168.100.4:9004@19004 master - 0 1595733488000 7 connected 1365-5460</span><br><span class="line">66fa35f56d59289e0f3e2b0f531b5c590f44b189 192.168.100.4:9005@19005 slave 953c929f0092a971e27d0c40b093c772ea9553bc 0 1595733489396 2 connected</span><br><span class="line">3c3a2216147a692b61b1de2a6f3806e0afa7cc87 192.168.100.4:9003@19003 master - 0 1595733488000 3 connected 12288-16383</span><br></pre></td></tr></table></figure>
<p><strong>刪除節點</strong><br>
被刪除的節點其所分配的 Slot 必須為 0，所以要先用 reshard 指令將 Slot 分配給其中一個 Master，再進行刪除。執行 Reshard 時會詢問要移動的 Slot 數量，這裡就把要刪除的節點的 Slot 數量全部填上去，接著再填入要接收 Slot 的 node Id 和要移出 Slot 的 node-Id，最後輸入 done 即完成。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-node7 redis-cli -p 9007 --cluster reshard 192.168.100.4:9007</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing Cluster Check (using node 192.168.100.4:9007)</span></span><br><span class="line">M: af228461d8ab2c1d9998a62e684bdf23dda851c1 192.168.100.4:9007</span><br><span class="line">   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master</span><br><span class="line">S: c0d1d6b5b817c479942d199a3da2b89b89958d0e 192.168.100.4:9001</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 9e7a868b38f55314e8bb61a1f2f527a07d1a7626</span><br><span class="line">M: 9e7a868b38f55314e8bb61a1f2f527a07d1a7626 192.168.100.4:9004</span><br><span class="line">   slots:[1365-5460] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: d1096e4d456e806d046461c108af4f20edee9f99 192.168.100.4:9006</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 3c3a2216147a692b61b1de2a6f3806e0afa7cc87</span><br><span class="line">M: 953c929f0092a971e27d0c40b093c772ea9553bc 192.168.100.4:9002</span><br><span class="line">   slots:[6827-10922] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 66fa35f56d59289e0f3e2b0f531b5c590f44b189 192.168.100.4:9005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 953c929f0092a971e27d0c40b093c772ea9553bc</span><br><span class="line">M: 3c3a2216147a692b61b1de2a6f3806e0afa7cc87 192.168.100.4:9003</span><br><span class="line">   slots:[12288-16383] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">How many slots do you want to move (from 1 to 16384)? 4096</span><br><span class="line">What is the receiving node ID? 9e7a868b38f55314e8bb61a1f2f527a07d1a7626</span><br><span class="line">Please enter all the source node IDs.</span><br><span class="line">  Type 'all' to use all the nodes as source nodes for the hash slots.</span><br><span class="line">  Type 'done' once you entered all the source nodes IDs.</span><br><span class="line">Source node #1: af228461d8ab2c1d9998a62e684bdf23dda851c1</span><br><span class="line">Source node #2: done</span><br></pre></td></tr></table></figure>
<p>此時再確認一下各節點的 Slot 數量，可以看到要刪除的 redis-node7 已經沒有 Slot，而 redis-node4 增加了許多 Slot。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-node7 redis-cli -p 9007 --cluster check 192.168.100.4:9007</span></span><br><span class="line">192.168.100.4:9007 (af228461...) -&gt; 0 keys | 0 slots | 0 slaves.</span><br><span class="line">192.168.100.4:9004 (9e7a868b...) -&gt; 0 keys | 8192 slots | 1 slaves.</span><br><span class="line">192.168.100.4:9002 (953c929f...) -&gt; 0 keys | 4096 slots | 1 slaves.</span><br><span class="line">192.168.100.4:9003 (3c3a2216...) -&gt; 0 keys | 4096 slots | 1 slaves.</span><br></pre></td></tr></table></figure>
<p>現在可以使用 del-node 指令將節點正式刪除。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it redis-node4 redis-cli -p 9004 --cluster del-node 192.168.100.4:9007 af228461d8ab2c1d9998a62e684bdf23dda851c1</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Removing node af228461d8ab2c1d9998a62e684bdf23dda851c1 from cluster 192.168.100.4:9007</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.</span></span><br></pre></td></tr></table></figure>
<h2 id="Summary"><a class="header-anchor" href="#Summary"></a>Summary</h2>
<p>本篇介紹了三種模式來實現多點資料庫，利用這些方式可以讓資料的可用性提升，但是相對的多點資料庫會導致資料一致性降低。</p>
<h2 id="參考"><a class="header-anchor" href="#參考"></a>參考</h2>
<p>[1] <a href="https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/507975/" target="_blank" rel="noopener">Redis 主從複製 原理與用法</a><br>
[2] <a href="https://www.lagou.com/lgeduarticle/44089.html" target="_blank" rel="noopener">Redis面试篇 – Redis主從複製原理</a><br>
[3] <a href="http://russellluo.com/2018/07/redis-replication-demystified.html#comments" target="_blank" rel="noopener">Redis replication 揭秘</a><br>
[4] <a href="https://kknews.cc/code/8znm9v4.html" target="_blank" rel="noopener">redis：詳解三種集群策略</a><br>
[5] <a href="https://juejin.im/post/5b7d226a6fb9a01a1e01ff64" target="_blank" rel="noopener">深入剖析Redis系列(二) - Redis哨兵模式與高可用集群</a><br>
[6] <a href="https://iter01.com/67985.html" target="_blank" rel="noopener">Redis 哨兵模式</a><br>
[7] <a href="https://zhuanlan.zhihu.com/p/91812982" target="_blank" rel="noopener">Redis 哨兵模式原理和部署</a><br>
[8] <a href="https://blog.csdn.net/GeeLoong/article/details/100144734?utm_medium=distribute.pc_relevant.none-task-blog-baidujs-1" target="_blank" rel="noopener">Redis Cluster 槽（Slot）</a><br>
[9] <a href="https://codingnote.cc/zh-tw/p/130780" target="_blank" rel="noopener">Redis學習筆記（十七） 集群（上）</a><br>
[10] <a href="https://blog.csdn.net/f919976711/article/details/85864540?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.nonecase&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.nonecase" target="_blank" rel="noopener">redis槽道原理</a><br>
[11] <a href="https://blog.csdn.net/hjjomiqpl/article/details/77324168?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-3.nonecase&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-3.nonecase" target="_blank" rel="noopener">如何理解Redis集群的Slot映射</a><br>
[12] <a href="https://kknews.cc/code/2x6jvqg.html" target="_blank" rel="noopener">Redis的高可用詳解：Redis哨兵、複製、集群的設計原理，以及區別</a><br>
[13] <a href="https://juejin.im/entry/596343056fb9a06bc340ac15" target="_blank" rel="noopener">Redis集群的原理和搭建</a><br>
[14] <a href="https://www.jianshu.com/p/b7dea62bcd8b" target="_blank" rel="noopener">Docker方式部署redis-cluster</a><br>
[15] <a href="https://blog.csdn.net/u010235716/article/details/104702045" target="_blank" rel="noopener">解决redis集群./redis-cli 啟動 Connection refused</a><br>
[16] <a href="https://juejin.im/post/5e7341606fb9a07cd11dbcf6" target="_blank" rel="noopener">一文掌握Redis主從複製、哨兵、Cluster三種集群模式</a><br>
[17] <a href="https://www.cnblogs.com/zhoujinyi/p/11606935.html" target="_blank" rel="noopener">Redis 5.0 redis-cli --cluster help說明</a><br>
[18] <a href="https://juejin.im/post/5e3a3bc8e51d4527107c7bfd" target="_blank" rel="noopener">Redis Cluster的两種搭建和簡單使用</a><br>
[19] <a href="https://blog.yowko.com/docker-compose-redis-cluster/" target="_blank" rel="noopener">使用 Docker Compose 建立 Redis Cluster</a><br>
[20] <a href="https://kefeng.wang/2018/08/01/distributed-cap/" target="_blank" rel="noopener">分布式系统的 CAP 定理</a></p>

    </div>

    
    
    
      
  <div class="popular-posts-header">系列文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/redis-3_pubsub/" rel="bookmark">Redis (三) - Pub/Sub 發佈訂閱</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/redis-1_concept-docker-install-datatype/" rel="bookmark">Redis (一) - 基本概念</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/redis-2_key-command/" rel="bookmark">Redis (二) - Key 的管理與操作</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/redis-5_server-management/" rel="bookmark">Redis (五) - 管理 Redis Server</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/redis-4_transaction/" rel="bookmark">Redis (四) - Transaction</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/elasticsearch-1_concept/" rel="bookmark">Elasticsearch (一) - 基本概念</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/elasticsearch-6_aggregation/" rel="bookmark">Elasticsearch (六) - Aggregation 聚合</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/elasticsearch-7_cluster-kibana-docker-compose/" rel="bookmark">Elasticsearch (七) - 多節點 Cluster 建立搭配 Kibana</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/elasticsearch-2_kibana-command-dsl-docker-compose/" rel="bookmark">Elasticsearch (二) - 快速搭建與 Document 的建立、更新和刪除</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/elasticsearch-3_query-filter/" rel="bookmark">Elasticsearch (三) - 查詢和過濾</a></div>
    </li>
  </ul>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Redis/" rel="tag"><i class="fa fa-tag"></i> Redis</a>
              <a href="/tags/NoSQL/" rel="tag"><i class="fa fa-tag"></i> NoSQL</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/redis-5_server-management/" rel="prev" title="Redis (五) - 管理 Redis Server">
      <i class="fa fa-chevron-left"></i> Redis (五) - 管理 Redis Server
    </a></div>
      <div class="post-nav-item">
    <a href="/nginx/" rel="next" title="Nginx (Engine X)">
      Nginx (Engine X) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- tienyulin.github -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-8271558544185929"
     data-ad-slot="8611071932"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#主從複製模式"><span class="nav-number">1.</span> <span class="nav-text">主從複製模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#工作流程"><span class="nav-number">1.1.</span> <span class="nav-text">工作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#範例"><span class="nav-number">1.2.</span> <span class="nav-text">範例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#哨兵模式"><span class="nav-number">2.</span> <span class="nav-text">哨兵模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#監控"><span class="nav-number">2.1.</span> <span class="nav-text">監控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主觀下線"><span class="nav-number">2.2.</span> <span class="nav-text">主觀下線</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客觀下線"><span class="nav-number">2.3.</span> <span class="nav-text">客觀下線</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#故障轉移-Failover"><span class="nav-number">2.4.</span> <span class="nav-text">故障轉移 (Failover)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#範例-v2"><span class="nav-number">2.5.</span> <span class="nav-text">範例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#故障轉移"><span class="nav-number">2.5.1.</span> <span class="nav-text">故障轉移</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#叢集模式"><span class="nav-number">3.</span> <span class="nav-text">叢集模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#資料分片"><span class="nav-number">3.1.</span> <span class="nav-text">資料分片</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#節點的資料結構與-Slots"><span class="nav-number">3.2.</span> <span class="nav-text">節點的資料結構與 Slots</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#工作流程-v2"><span class="nav-number">3.3.</span> <span class="nav-text">工作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#故障轉移-v2"><span class="nav-number">3.4.</span> <span class="nav-text">故障轉移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#節點增加與刪除"><span class="nav-number">3.5.</span> <span class="nav-text">節點增加與刪除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#範例-v3"><span class="nav-number">3.6.</span> <span class="nav-text">範例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number">4.</span> <span class="nav-text">Summary</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#參考"><span class="nav-number">5.</span> <span class="nav-text">參考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tien-Yu Lin"
      src="/images/tienyu.jpg">
  <p class="site-author-name" itemprop="name">Tien-Yu Lin</p>
  <div class="site-description" itemprop="description">Try not to become a man of success, but rather try to become a man of value. - Albert Einstein</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">45</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/tienyulin" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;tienyulin" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://hub.docker.com/u/tienyu" title="DockerHub → https:&#x2F;&#x2F;hub.docker.com&#x2F;u&#x2F;tienyu" rel="noopener" target="_blank"><i class="fab fa-docker fa-fw"></i>DockerHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:t.tienyulin@gmail.com" title="E-Mail → mailto:t.tienyulin@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/tony-lin-79733714b/" title="Linkedin → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;tony-lin-79733714b&#x2F;" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i>Linkedin</a>
      </span>
  </div>



      </div>

      <!--google_adsense-->	      
      	 
        <div class="links-of-blogroll-title">	     
          <i class="fa fa-google"></i> AdSense	       
          <ins class="adsbygoogle"	      
              style="display:block"	     
              data-ad-client="ca-pub-8271558544185929"	
              data-ad-slot="8611071932"	
              data-ad-format="auto"	
              data-full-width-responsive="true"></ins>	
          <script>	
            (adsbygoogle = window.adsbygoogle || []).push({});	
          </script>	
        </div>	
      	
      <!--/google_adsense-->

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tien-Yu Lin</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://tienyulin.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://tienyulin.github.io/redis-6_master-slave-replication-sentinel-cluster/";
    this.page.identifier = "redis-6_master-slave-replication-sentinel-cluster/";
    this.page.title = "Redis (六) - 主從複製、哨兵與叢集模式";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://tienyulin.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
